* 本資料は草稿段階である。
* 本資料はある程度技術的素養がある新人のWebアプリケーションエンジニア向けの講義資料として書かれている。
* 本資料に関して間違いや誤解を招く点を発見した場合、Issueに報告して頂けると幸いである。

# プロトコルの基礎知識とセキュリティ上の勘所

Webアプリケーションは大きな見方をすれば、ネットワークを通じて外部と通信する処理が中心となるアプリケーションといえる。  
そのため、様々なプロトコルがアプリケーションに遠からず関係することになる。  
ここではいくつかの主要なプロトコルの概要と、セキュリティ上で起き得る（起き得た）問題について解説する。

* [x] TCPとUDP
* [ ] HTTP
* [ ] HTTPS(TLS)
* [ ] SMTP/POP3/IMAP4

# TCPとUDP

コンピュターがネットワークを通じて外部と通信するためのプロトコルについて考える。  
ソフトウェア上からは主にOSI基本参照モデルの第4層（トランスポート層）以上が関係する。  
※ネットワーク層をプログラマブルにするOpen Flowという技術もあるが今回は割愛する。

## TCPの特徴

TCPには以下のような特徴がある。

* セッションを確立してから実際の通信が始まる
  * セッションの確立にコストが掛かる
  * 3way hand shakingと呼ばれる方法でセッションを確立する(SYN/ACK+SYN/ACK)
  * 存在しない相手/不正な相手とは通信が行えない
* フロー制御/再送制御/輻輳制御が行われる
  * パケットが正しい順番で届くことを保障する
  * 一部のパケットが通信の過程でロスした場合、再送させる
  * パケットを受信したら、どこまで受信したかを示すパケットを返す
  * ネットワークリソースの状態に応じて送信するデータ量を制御する

これらの特徴を利用した攻撃として、たとえば以下のようなものが考えられる。

* SYNを大量に送信し、SYN+ACKを送信させセッションの確立を待機させる
  * セッションの確立を待機するためのリソースを意図的に消費させることができる→正規のセッションの確立を妨害できる
  * 正規のセッションの確立を妨害することで、アプリケーションへのアクセスを妨害することが可能
  * SYN flood攻撃と呼ばれている
  * SYN cookiesと呼ばれる方法により対策が可能（ほとんどのLinuxディストリビューションではデフォルトでONとなっている）
    * 似た攻撃手法としてARP floodingやMAC floodingと呼ばれるものもある

下で解説するような、UDP通信の特徴を悪用して行えるような攻撃のほとんどはTCP通信に対しては行うことはできない。
独自にプロトコルを定義する必要があるばあい、基本的にはTCPを用いるのが良いだろう。

## UDPの特徴

* セッションを確立する必要が無い
  * 低コストで通信が行える
  * 存在しない相手/不正な相手からデータを受け取る可能性がある
* フロー制御/再送制御/輻輳制御が行われない
  * 一部のパケットが通信の過程でロスした場合、再送されないなど、確実にデータが届く保障は無い
  * ただし、現実的にだいたいのデータが届く

これらの特徴を利用した攻撃として、以下のようなものが考えられる。

* DNSのキャッシュからの副問い合わせ(再起問い合わせ)に対して不正なIPアドレスを示すUDPパケットを送り副問い合わせのレスポンスとして認識させる
  * 任意のドメインを任意のIPアドレスに結びつける事が可能
  * DNSキャッシュポイズニングと呼ばれている
    * 以前は、現実的に攻撃が困難だろうと思われていたが、2008年にKaminsky Attackと呼ばれる手法が発見され、攻撃が比較的容易になった。
  * Source port randomizationにより対策が可能（多くのDNSサーバーにこの機能がある）
  * 副問い合わせの挙動を制限するオプションが利用出来る場合もあるので設定するとなお良い
  * DNSSECというDNS問い合わせを暗号化する仕様も存在するが普及が進んでいない

UDPを使った通信に信頼性が必要なケースは注意が必要である。
ただし、TCPと比較するとセッションの確立が不要であり、ACKの送信も不要なので、ネットワークコストは下がる。
たとえば、動画や音声のストリーミングにはよくUDPが用いられる。

## 勘所

* アプリケーションから遠いところにも脆弱性のタネはある。
  * TCP/IPの上に独自のプロトコルを定義する必要が出た場合、これらの特徴についてよく理解した上でプロトコルを選び、プロトコルを定義する必要がある。
  * アプリケーションエンジニアがサーバーの運用なども行う場合、これら低レイヤのプロトコルについても注意する必要がある。
* 現状の対策では防げないほどコンピューターの性能が進化したり、新たな攻撃手法が発見される場合がある。
  * 常に最新の情報を仕入れる必要がある。あらゆる対策はいつの日か破られる日が来る可能性を秘めている。
* あらゆる仕様は見方を変えることで攻撃に利用できてしまう場合がある。

## 参考資料

* [3分間ネットワーキング](http://www5e.biglobe.ne.jp/%257eaji/3min/)
* [IPA TCP/IPに係る既知の脆弱性に関する調査報告書](https://www.ipa.go.jp/security/vuln/vuln_TCPIP.html)
* [IPA DNSキャッシュポイズニング対策](https://www.ipa.go.jp/security/vuln/DNS_security.html)
* [Kaminsky Attackの全て](https://www.nic.ad.jp/ja/materials/iw/2008/proceedings/H3/IW2008-H3-07.pdf)
* [マスタリング TCP/IP](http://www.amazon.co.jp/dp/4274068765/)

